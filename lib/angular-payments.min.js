/*! angular-payments 09-12-2016 */
"use strict";angular.module("angularPayments",[]),angular.module("angularPayments").factory("Common",[function(){var a={};return a.parseExpiry=function(a){var b,c,d,e;return a=a||"",a=a.replace(/\s/g,""),e=a.split("/",2),b=e[0],d=e[1],d&&2===(null!==d?d.length:void 0)&&/^\d+$/.test(d)&&(c=(new Date).getFullYear(),c=c.toString().slice(0,2),d=c+d),b=parseInt(b,10),d=parseInt(d||(new Date).getFullYear(),10),{month:b,year:d}},a}]),angular.module("angularPayments").factory("Cards",[function(){var a=/(\d{1,4})/g,b=/(?:^|\s)(\d{4})$/,c=[{type:"samsconsumer",pattern:/^(604599)/,format:a,inputFormat:b,length:[16],cvcLength:[3],luhn:!0},{type:"samsbusiness",pattern:/^(604600)/,format:a,inputFormat:b,length:[16],cvcLength:[3],luhn:!0},{type:"maestro",pattern:/^(5018|5020|5038|6304|6759|676[1-3])/,format:a,inputFormat:b,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"dinersclub",pattern:/^(36|38|30[0-5])/,format:a,inputFormat:b,length:[14],cvcLength:[3],luhn:!0},{type:"laser",pattern:/^(6706|6771|6709)/,format:a,inputFormat:b,length:[16,17,18,19],cvcLength:[3],luhn:!0},{type:"jcb",pattern:/^35/,format:a,inputFormat:b,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",pattern:/^62/,format:a,inputFormat:b,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"discover",pattern:/^(6011|65|64[4-9]|622)/,format:a,inputFormat:b,length:[16],cvcLength:[3],luhn:!0},{type:"mastercard",pattern:/^5[1-5]|^2(?:2(?:2[1-9]|[3-9]\d)|[3-6]\d\d|7(?:[01]\d|20))/,format:a,inputFormat:b,length:[16],cvcLength:[3],luhn:!0},{type:"amex",pattern:/^3[47]/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,inputFormat:/^(\d{4}|\d{4}\s\d{6})$/,length:[15],cvcLength:[3,4],luhn:!0},{type:"visa",pattern:/^4/,format:a,inputFormat:b,length:[13,14,15,16],cvcLength:[3],luhn:!0}],d=function(a){var b,d,e;for(a=(a+"").replace(/\D/g,""),d=0,e=c.length;e>d;d++)if(b=c[d],b.pattern.test(a))return b},e=function(a){var b,d,e;for(d=0,e=c.length;e>d;d++)if(b=c[d],b.type===a)return b};return{fromNumber:function(a){return d(a)},fromType:function(a){return e(a)},defaultFormat:function(){return a},defaultInputFormat:function(){return b}}}]),angular.module("angularPayments").factory("_Format",["Cards","Common","$filter",function(a,b,c){var d={},e=function(a){var b;return null!==a.prop("selectionStart")&&a.prop("selectionStart")!==a.prop("selectionEnd")?!0:"undefined"!=typeof document&&null!==document&&null!=(b=document.selection)&&"function"==typeof b.createRange?b.createRange().text:void 0},f=function(b){var c,d,e,f,g,h;if(c=angular.element(b.currentTarget),c.val(c.val().replace(/[^0-9 ]+/g,"")),h=c.val(),d=a.fromNumber(h),e=h.replace(/\D/g,"").length,g=16,d&&(g=d.length[d.length.length-1]),e>=g){var i=g-e;i&&c.val(h.slice(0,i))}return null===c.prop("selectionStart")||c.prop("selectionStart")===h.length?(f=a.defaultInputFormat(),d&&(f=d.inputFormat),f.test(h)?c.val(h+" "):void 0):void 0},g=function(b){var c,d,f;c=angular.element(b.currentTarget),f=c.val().replace(/[^0-9]+/g,""),8===b.which||9===b.which||e(c)||(d=a.fromNumber(f),d?f.length>=d.length[d.length.length-1]&&b.preventDefault():f.length>=16&&b.preventDefault())},h=function(a){var b,c;return b=angular.element(a.currentTarget),c=b.val().replace(/[^0-9 ]+/g,""),a.meta||8!==a.which?void 0:/\d\s$/.test(c)&&!a.meta?(a.preventDefault(),b.val(c.replace(/\d\s$/,""))):/\s\d?$/.test(c)?(a.preventDefault(),b.val(c.replace(/\s\d?$/,""))):void 0},i=function(b){var c,d,e,f;return(c=a.fromNumber(b))?(e=c.length[c.length.length-1],b=b.replace(/\D/g,""),b=b.slice(0,+e+1||9e9),c.format.global?null!=(f=b.match(c.format))?f.join(" "):void 0:(d=c.format.exec(b),null!=d&&d.shift(),null!=d?d.join(" "):void 0)):b},j=function(a){return setTimeout(function(){var b,c;return b=angular.element(a.target),c=b.val(),c=i(c),b.val(c)})},k=function(a){return null!=a?a.replace(/\s/g,""):a};d.card=function(a,b){a.bind("keydown",g),a.bind("keydown",h),a.bind("input",f),a.bind("paste",j),b.$parsers.push(k),b.$formatters.push(i)};var l=function(a){var b;b=angular.element(a.currentTarget),b.val(b.val().replace(/[^0-9]+/g,"").substring(0,4))},m=function(a){var b,c;return b=angular.element(a.currentTarget),c=b.val().replace(/[^0-9]+/g,""),8!==a.which&&9!==a.which&&c.length>=4?void a.preventDefault():void 0};d.cvc=function(a){a.bind("keydown",m),a.bind("input",l)};var n=function(a){return/^\d$/.test(a)&&"0"!==a&&"1"!==a?"0"+a+" / ":a.length>1?a.substring(0,2)+" / "+a.substring(2,6):a},o=function(a){var b,c;b=angular.element(a.currentTarget),b.val(b.val().replace(/[^0-9]+/g,"")),c=b.val().slice(0,6);var d=n(c);return d?b.val(d):void 0},p=function(a){var b,c;if(b=angular.element(a.currentTarget),c=b.val().replace(/[^0-9]+/g,""),!a.meta&&8===a.which){a.preventDefault();var d=n(c.substring(0,c.length-1));return b.val(d)}},q=function(a){var b,c;return b=angular.element(a.currentTarget),c=b.val().replace(/[^0-9]+/g,""),8!==a.which&&9!==a.which&&c.length>=6?void a.preventDefault():void 0},r=function(a){if(null!=a){var d=b.parseExpiry(a),e=new Date(d.year,d.month-1);return c("date")(e,"MM/yyyy")}return null},s=function(a){if(null!=a){var d=b.parseExpiry(a),e=new Date(d.year,d.month-1);return c("date")(e,"MM / yyyy")}return null};return d.expiry=function(a,b){a.bind("keydown",q),a.bind("keydown",p),a.bind("input",o),b.$parsers.push(r),b.$formatters.push(s)},function(a,b,c){var e,f;if(!d[a])throw e=Object.keys(d),f='Unknown type for formatting: "'+a+'". ',f+='Should be one of: "'+e.join('", "')+'"';return d[a](b,c)}}]).directive("paymentsFormat",["$window","_Format",function(a,b){return{restrict:"A",require:"ngModel",link:function(a,c,d,e){b(d.paymentsFormat,c,e)}}}]),angular.module("angularPayments").factory("_Validate",["Cards","Common","$parse",function(a,b,c){var d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},e=function(a){var b,c,d,e,f,g;for(d=!0,e=0,c=(a+"").split("").reverse(),f=0,g=c.length;g>f;f++)b=c[f],b=parseInt(b,10),(d=!d)&&(b*=2),b>9&&(b-=9),e+=b;return e%10===0},f={};return f.cvc=function(b,e,f,g){var h,i;if(null==b||0==b.length)return!0;if(!/^\d+$/.test(b))return!1;var j;if(g.paymentsTypeModel){var k=c(g.paymentsTypeModel);j=k(f)}return j?(h=b.length,d.call(null!=(i=a.fromType(j))?i.cvcLength:void 0,h)>=0):b.length>=3&&b.length<=4},f.card=function(b,f,g,h){var i,j,k,l;h.paymentsTypeModel&&(l=c(h.paymentsTypeModel));var m=function(){l&&l.assign(g,null),f.$card=null};return null==b||0==b.length?(m(),!0):(b=(b+"").replace(/\s+|-/g,""),/^\d+$/.test(b)&&(i=a.fromNumber(b))?(f.$card=angular.copy(i),l&&l.assign(g,i.type),j=b.length,k=d.call(i.length,j)>=0&&(i.luhn===!1||e(b)),k):(m(),!1))},f.expiry=function(a){var c,d,e;if(null===a||0===a.length)return!0;c=b.parseExpiry(a),d=c.month,e=c.year;var f,g,h;return d&&e&&/^\d+$/.test(d)&&/^\d+$/.test(e)&&parseInt(d,10)<=12?(2===e.length&&(h=(new Date).getFullYear(),h=h.toString().slice(0,2),e=h+e),g=new Date(e,d),f=new Date,g.setMonth(g.getMonth()-1),g.setMonth(g.getMonth()+1,1),g>f):!1},function(a,b,c,d,e){var g,h;if(!f[a])throw g=Object.keys(f),h='Unknown type for validation: "'+a+'". ',h+='Should be one of: "'+g.join('", "')+'"';return f[a](b,c,d,e)}}]).factory("_ValidateWatch",["_Validate",function(a){var b={};return b.cvc=function(b,c,d,e){e.paymentsTypeModel&&d.$watch(e.paymentsTypeModel,function(f,g){if(f!=g){var h=a(b,c.$modelValue,c,d,e);c.$setValidity(b,h)}})},function(a,c,d,e){return b[a]?b[a](a,c,d,e):void 0}}]).directive("paymentsValidate",["$window","_Validate","_ValidateWatch",function(a,b,c){return{restrict:"A",require:"ngModel",link:function(a,d,e,f){var g=e.paymentsValidate;c(g,f,a,e);var h=function(c){var d=b(g,c,f,a,e);return f.$setValidity(g,d),d?c:void 0};f.$formatters.push(h),f.$parsers.push(h)}}}]),angular.module("angularPayments").directive("stripeForm",["$window","$parse","Common",function(a,b,c){var d=function(a){var b=["number","expMonth","expYear","expiry","cvc","name","addressLine1","addressLine2","addressCity","addressState","addressZip","addressCountry"],d=function(a){return a.replace(/([A-Z])/g,function(a){return"_"+a.toLowerCase()})},e={};for(var f in b)if(b.hasOwnProperty(f)&&a.hasOwnProperty(b[f])&&a[b[f]])if("expiry"===b[f]){var g=c.parseExpiry(a[b[f]].$modelValue);e[d("expMonth")]=g.month,e[d("expYear")]=g.year}else e[d(b[f])]=angular.copy(a[b[f]].$modelValue);return e.number=(e.number||"").replace(/ /g,""),e};return{restrict:"A",link:function(b,c,e){if(!a.Stripe)throw"stripeForm requires that you have stripe.js installed. Include https://js.stripe.com/v2/ into your html.";var f=angular.element(c),g=b[e.name];f.bind("submit",function(){if(g.number&&g.cvc){var c=f.find("button");c.prop("disabled",!0),f.hasClass("ng-valid")?a.Stripe.createToken(d(b[e.name]),function(){var a=arguments;b.$apply(function(){b[e.stripeForm].apply(b,a)}),c.prop("disabled",!1)}):(b.$apply(function(){b[e.stripeForm].apply(b,[400,{error:"Invalid form submitted."}])}),c.prop("disabled",!1)),b.expMonth=null,b.expYear=null}else{var h=arguments;b.$apply(function(){b[e.stripeForm].apply(b,h)})}})}}}]);